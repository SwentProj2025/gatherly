package com.android.gatherly.viewmodel.settings

import android.net.Uri
import com.android.gatherly.model.profile.Profile
import com.android.gatherly.model.profile.ProfileLocalRepository
import com.android.gatherly.ui.settings.SettingsViewModel
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.ExperimentalCoroutinesApi
import kotlinx.coroutines.test.StandardTestDispatcher
import kotlinx.coroutines.test.advanceUntilIdle
import kotlinx.coroutines.test.resetMain
import kotlinx.coroutines.test.runTest
import kotlinx.coroutines.test.setMain
import org.junit.After
import org.junit.Assert.*
import org.junit.Before
import org.junit.Test
import org.mockito.ArgumentMatchers.any
import org.mockito.Mockito

// Part of this code was generated by an LLM

/** Unit tests for [SettingsViewModel]. */
@OptIn(ExperimentalCoroutinesApi::class)
class SettingsViewModelTest {

  private val testDispatcher = StandardTestDispatcher()
  private lateinit var repo: ProfileLocalRepository
  private lateinit var viewModel: SettingsViewModel

  @Before
  fun setup() {
    Dispatchers.setMain(testDispatcher)
    repo = ProfileLocalRepository()
    fill_repository()

    viewModel = SettingsViewModel(repo, "currentUser")
  }

  @After
  fun tearDown() {
    Dispatchers.resetMain()
  }

  fun fill_repository() = runTest {
    repo.initProfileIfMissing("currentUser", "")
    advanceUntilIdle()
  }

  // ------------------------------------------------------------------------
  // PROFILE LOADING
  // ------------------------------------------------------------------------

  @Test
  fun loadProfile_LoadsExistingProfileIntoUiState() = runTest {
    val profile =
        Profile(
            uid = "u1", name = "Alice", username = "alice_ok", school = "Harvard", schoolYear = "3")
    repo.addProfile(profile)

    viewModel.loadProfile("u1")
    advanceUntilIdle()

    val state = viewModel.uiState.value
    assertEquals("Alice", state.name)
    assertEquals("alice_ok", state.username)
    assertEquals("Harvard", state.school)
    assertEquals("3", state.schoolYear)
    assertNull(state.errorMsg)
  }

  @Test
  fun loadProfile_WhenMissing_CreatesDefaultProfile() = runTest {
    viewModel.loadProfile("new_user")
    advanceUntilIdle()

    val state = viewModel.uiState.value
    assertEquals("", state.name)
    assertEquals("", state.username)
    assertFalse(state.isValid)
    assertNull(state.errorMsg)
  }

  // ------------------------------------------------------------------------
  // FIELD VALIDATION
  // ------------------------------------------------------------------------

  @Test
  fun editName_WithBlankName_SetsInvalidMessage() = runTest {
    viewModel.editName("")
    advanceUntilIdle()

    val state = viewModel.uiState.value
    assertEquals("Name cannot be empty", state.invalidNameMsg)
    assertFalse(state.isValid)
  }

  @Test
  fun editBirthday_WithInvalidDate_SetsErrorMessage() = runTest {
    viewModel.editBirthday("99/99/9999")
    advanceUntilIdle()

    val state = viewModel.uiState.value
    assertEquals("Date is not valid (format: dd/mm/yyyy)", state.invalidBirthdayMsg)
    assertFalse(state.isValid)
  }

  @Test
  fun editBirthday_WithValidDate_ClearsErrorMessage() = runTest {
    viewModel.editName("Alice")
    viewModel.editUsername("alice_ok")
    viewModel.editBirthday("10/12/2024")
    advanceUntilIdle()

    val state = viewModel.uiState.value
    assertNull(state.invalidBirthdayMsg)
    assertTrue(state.isValid)
  }

  @Test
  fun editPhoto_updatesProfilePictureUrl() {
    val newUrl = "https://example.com/pic.jpg"
    viewModel.editPhoto(newUrl)
    assertEquals(newUrl, viewModel.uiState.value.profilePictureUrl)
  }

  // ------------------------------------------------------------------------
  // USERNAME VALIDATION & AVAILABILITY
  // ------------------------------------------------------------------------

  @Test
  fun editUsername_WithInvalidFormat_SetsErrorMessage() = runTest {
    viewModel.editUsername("Bad!!Name")
    advanceUntilIdle()

    val state = viewModel.uiState.value
    assertEquals(
        "Invalid username format (3â€“20 chars, lowercase, ., -, _ allowed)",
        state.invalidUsernameMsg)
    assertNull(state.isUsernameAvailable)
    assertFalse(state.isValid)
  }

  @Test
  fun editUsername_WithValidName_ChecksAvailability() = runTest {
    viewModel.editUsername("valid_name")
    advanceUntilIdle()

    val state = viewModel.uiState.value
    assertNull(state.invalidUsernameMsg)
    assertNotNull(state.isUsernameAvailable)
  }

  // ------------------------------------------------------------------------
  // PROFILE UPDATES
  // ------------------------------------------------------------------------

  @Test
  fun updateProfile_WithValidData_UpdatesRepositoryAndClearsError() = runTest {
    val profile = Profile(uid = "u1", name = "Alice", username = "old_name")
    repo.addProfile(profile)

    viewModel.loadProfile("u1")
    advanceUntilIdle()

    viewModel.editName("Bob")
    viewModel.editUsername("new_user")
    advanceUntilIdle()

    viewModel.updateProfile("u1", isFirstTime = true)
    advanceUntilIdle()

    val updated = repo.getProfileByUid("u1")
    assertEquals("Bob", updated?.name)
    assertEquals("new_user", updated?.username)
    assertNull(viewModel.uiState.value.errorMsg)
  }

  @Test
  fun updateProfile_WhenInvalidName_SetsErrorMsgAndDoesNotUpdate() = runTest {
    val profile = Profile(uid = "u1", name = "Alice", username = "ok")
    repo.addProfile(profile)

    viewModel.loadProfile("u1")
    advanceUntilIdle()

    viewModel.editName("") // invalid
    viewModel.editUsername("ok")

    viewModel.updateProfile("u1", isFirstTime = true)
    advanceUntilIdle()

    val updated = repo.getProfileByUid("u1")
    assertEquals("Alice", updated?.name)
    assertEquals("ok", updated?.username)
    assertEquals("At least one field is not valid.", viewModel.uiState.value.errorMsg)
  }

  @Test
  fun updateProfile_WhenUsernameAlreadyTaken_SetsErrorMsg() = runTest {
    // simulate repo already containing username
    val existing = Profile(uid = "u2", name = "Bob", username = "taken_name")
    repo.addProfile(existing)

    val newProfile = Profile(uid = "u1", name = "Alice", username = "old_name")
    repo.addProfile(newProfile)

    viewModel.loadProfile("u1")
    advanceUntilIdle()

    viewModel.editName("Alice Updated")
    viewModel.editUsername("taken_name")
    advanceUntilIdle()

    viewModel.updateProfile("u1", isFirstTime = true)
    advanceUntilIdle()

    assertEquals("At least one field is not valid.", viewModel.uiState.value.errorMsg)
  }

  // ------------------------------------------------------------------------
  // SAVE SUCCESS & USERNAME CHANGE BEHAVIOR
  // ------------------------------------------------------------------------

  @Test
  fun updateProfile_WhenUsernameUnchanged_DoesNotTriggerError() = runTest {
    val existing = Profile(uid = "u1", name = "Alice", username = "same_user")
    repo.addProfile(existing)

    viewModel.loadProfile("u1")
    advanceUntilIdle()

    // Change only name, keep username same
    viewModel.editName("Alice Updated")
    advanceUntilIdle()

    viewModel.updateProfile("u1", isFirstTime = false)
    advanceUntilIdle()

    val state = viewModel.uiState.value
    assertNull(state.errorMsg)
    assertTrue("Expected saveSuccess to be true", state.saveSuccess)
  }

  @Test
  fun updateProfile_WhenValid_ShowsSaveSuccessFlag() = runTest {
    val profile = Profile(uid = "u1", name = "Alice", username = "user_ok")
    repo.addProfile(profile)

    viewModel.loadProfile("u1")
    advanceUntilIdle()

    viewModel.editName("Alice Updated")
    viewModel.editUsername("user_ok_new")
    advanceUntilIdle()

    viewModel.updateProfile("u1", isFirstTime = false)
    advanceUntilIdle()

    val updated = repo.getProfileByUid("u1")
    assertEquals("Alice Updated", updated?.name)
    assertEquals("user_ok_new", updated?.username)
    assertTrue(viewModel.uiState.value.saveSuccess)
  }

  @Test
  fun clearSaveSuccess_ResetsFlag() = runTest {
    viewModel.editName("Test")
    viewModel.editUsername("valid_name")
    advanceUntilIdle()
    viewModel.updateProfile("id1", isFirstTime = true)
    advanceUntilIdle()

    viewModel.clearSaveSuccess()
    assertFalse(viewModel.uiState.value.saveSuccess)
  }

  @Test
  fun updateProfile_WhenRepositoryReturnsFalse_SetsUsernameTakenError() = runTest {
    // GIVEN an existing valid profile
    val existing = Profile(uid = "u1", name = "Alice", username = "old_name")
    repo.addProfile(existing)

    // Override repo behavior to simulate failure on username registration
    repo.shouldFailRegisterUsername = true

    viewModel.loadProfile("u1")
    advanceUntilIdle()

    // User edits to a new username
    viewModel.editName("Alice Updated")
    viewModel.editUsername("new_user")
    advanceUntilIdle()

    // WHEN updateProfile is called
    viewModel.updateProfile("u1", isFirstTime = true)
    advanceUntilIdle()

    // THEN the ViewModel should report the username invalid/taken error
    val state = viewModel.uiState.value
    assertEquals("Username is invalid or already taken.", state.errorMsg)
    assertFalse(state.saveSuccess)
    repo.shouldFailRegisterUsername = false
  }

  @Test
  fun updateProfilePicture_WhenUrlUnchanged_DoesNotChangeRepository() = runTest {
    val uid = "u1"
    val repo = ProfileLocalRepository()
    val viewModel = SettingsViewModel(repository = repo, currentUser = uid)

    val originalProfile = Profile(uid = uid, name = "Alice", username = "alice_ok", profilePicture = "same_url")
    repo.addProfile(originalProfile)

    viewModel.loadProfile(uid)
    advanceUntilIdle()

    // WHEN user saves without changing picture
    viewModel.editProfilePictureUrl("same_url")
    viewModel.updateProfile(uid, isFirstTime = false)
    advanceUntilIdle()

    val updated = repo.getProfileByUid(uid)
    assertEquals("same_url", updated?.profilePicture)
    assertTrue(viewModel.uiState.value.saveSuccess)
  }

  //Used ChatGpt for this test to implement Mockito and help use parse even though we are in unit tests.
  @Test
  fun updateProfilePicture_WhenUrlChanged_CallsRepoAndUpdatesProfile() = runTest {
    val uid = "u1"
    val repo = ProfileLocalRepository()
    val viewModel = SettingsViewModel(repository = repo, currentUser = uid)

    //Mock Uri.parse() to bypass Android runtime
    val fakeUri = Mockito.mock(Uri::class.java)
    Mockito.mockStatic(Uri::class.java).use { mockedStatic ->
      mockedStatic.`when`<Uri> { Uri.parse(any()) }.thenReturn(fakeUri)

      // GIVEN an existing profile
      val originalProfile = Profile(
        uid = uid,
        name = "Alice",
        username = "alice_ok",
        profilePicture = "old_url"
      )
      repo.addProfile(originalProfile)

      // WHEN user changes profile picture
      viewModel.loadProfile(uid)
      advanceUntilIdle()
      viewModel.editProfilePictureUrl("https://example.com/new.png")
      viewModel.editName("Alice")
      viewModel.editUsername("alice_ok")
      advanceUntilIdle()

      viewModel.updateProfile(uid, isFirstTime = false)
      advanceUntilIdle()

      // THEN repository should now have updated URL
      val updated = repo.getProfileByUid(uid)
      assertEquals("https://local.test.storage/$uid.jpg", updated?.profilePicture)
      assertTrue(viewModel.uiState.value.saveSuccess)
      assertNull(viewModel.uiState.value.errorMsg)
    }
  }


}
