package com.android.gatherly.utils

import com.android.gatherly.model.notification.Notification
import com.android.gatherly.model.notification.NotificationType
import com.android.gatherly.model.notification.NotificationsRepository
import com.android.gatherly.model.notification.NotificationsRepositoryFirestore
import com.google.firebase.Timestamp
import com.google.firebase.auth.GoogleAuthProvider
import kotlinx.coroutines.tasks.await
import kotlinx.coroutines.test.runTest
import org.junit.After
import org.junit.Before
import kotlin.time.Duration.Companion.seconds

// This file contains code generated by an LLM (Claude.ai, Gemini).

/**
 * Base class for Firestore-based Notifications tests using the Firebase Emulator Suite.
 *
 * Before running, start the emulators: firebase emulators:start
 */
open class FirestoreNotificationsGatherlyTest {

  /**
   * The NotificationRepository instance backed by the Firestore emulator. Initialized during
   * setUp() and used for testing repository operations.
   */
  protected lateinit var repository: NotificationsRepository

  // Create fake tokens for different users
  protected val user1Token = FakeJwtGenerator.createFakeGoogleIdToken("Alice", "alice@test.com")
  protected val user2Token = FakeJwtGenerator.createFakeGoogleIdToken("Bob", "bob@test.com")
  protected val user3Token = FakeJwtGenerator.createFakeGoogleIdToken("Geoff", "geoff@test.com")
  protected val user4Token = FakeJwtGenerator.createFakeGoogleIdToken("Donna", "donna@test.com")

  /**
   * The unique identifiers for the test users in the Firebase Auth emulator. Set dynamically during
   * setUp() after authentication.
   */
  protected lateinit var user1Id: String
  protected lateinit var user2Id: String
  protected lateinit var user3Id: String
  protected lateinit var user4Id: String

  /** Helper function to create timestamps for testing purposes. */
  private fun createTimestamp(seconds: Long, nanoseconds: Int = 0): Timestamp {
    return Timestamp(seconds, nanoseconds)
  }

  // --- Test Fixture Templates ---
  // These are templates. In your tests, you will use .copy() to set the
  // dynamic senderId and recipientId (e.g., user1Id, user2Id).

  protected val friendRequest1_template =
      Notification(
          id = "", // To be set
          type = NotificationType.FRIEND_REQUEST,
          emissionTime = createTimestamp(1000, 0),
          senderId = "", // To be set to a dynamic user ID in tests
          relatedEntityId = null, // Friend requests don't have a related entity
          recipientId = "", // To be set to a dynamic user ID in tests
          wasRead = false)

  protected val friendRequest2_template =
      Notification(
          id = "", // To be set
          type = NotificationType.FRIEND_REQUEST,
          emissionTime = createTimestamp(2000, 0),
          senderId = "", // To be set
          relatedEntityId = null, // Friend requests don't have a related entity
          recipientId = "", // To be set
          wasRead = false)

  protected val todoReminder1_template =
      Notification(
          id = "", // To be set
          type = NotificationType.TODO_REMINDER,
          emissionTime = createTimestamp(4000, 0),
          senderId = null, // System-generated, no sender
          relatedEntityId = "todo1",
          recipientId = "", // To be set
          wasRead = false)

  protected val todoReminder2_template =
      Notification(
          id = "", // To be set
          type = NotificationType.TODO_REMINDER,
          emissionTime = createTimestamp(5000, 0),
          senderId = null, // System-generated, no sender
          relatedEntityId = "todo2",
          recipientId = "", // To be set
          wasRead = false)

  protected val eventReminder1_template =
      Notification(
          id = "", // To be set
          type = NotificationType.EVENT_REMINDER,
          emissionTime = createTimestamp(7000, 0),
          senderId = null, // System-generated, no sender
          relatedEntityId = "event1",
          recipientId = "", // To be set
          wasRead = false)

  protected val eventReminder2_template =
      Notification(
          id = "", // To be set
          type = NotificationType.EVENT_REMINDER,
          emissionTime = createTimestamp(8000, 0),
          senderId = null, // System-generated, no sender
          relatedEntityId = "event2",
          recipientId = "", // To be set
          wasRead = false)

  /**
   * Sets up the test environment before each test.
   *
   * This method performs the following steps:
   * 1. Verifies the Firebase emulator is running
   * 2. Clears all existing authentication and Firestore data
   * 3. Seeds test users in the Auth emulator
   * 4. Signs in as user1 (Alice) by default and captures other user IDs
   * 5. Initializes the NotificationRepository with the emulator Firestore instance
   *
   * @throws IllegalStateException if the Firebase emulator is not running
   */
  @Before
  open fun setUp() = runTest (timeout = 120.seconds) {
    if (!FirebaseEmulator.isRunning) {
      error("Firebase emulator must be running! Use: firebase emulators:start")
    }

    // Clear any existing users and data
    FirebaseEmulator.auth.signOut()
    FirebaseEmulator.clearAuthEmulator()
    FirebaseEmulator.clearFirestoreEmulator()

    // Seed users in emulator
    FirebaseEmulator.createGoogleUser(user1Token)
    FirebaseEmulator.createGoogleUser(user2Token)
    FirebaseEmulator.createGoogleUser(user3Token)
    FirebaseEmulator.createGoogleUser(user4Token)

    // Sign in as user1 by default
    signInWithToken(user1Token)
    user1Id = FirebaseEmulator.auth.currentUser!!.uid

    // Store user IDs 2, 3, 4 by signing in temporarily and then restore user1
    signInWithToken(user2Token)
    user2Id = FirebaseEmulator.auth.currentUser!!.uid
    signInWithToken(user3Token)
    user3Id = FirebaseEmulator.auth.currentUser!!.uid
    signInWithToken(user4Token)
    user4Id = FirebaseEmulator.auth.currentUser!!.uid
    // Switch back to user1
    signInWithToken(user1Token)

    repository = NotificationsRepositoryFirestore(FirebaseEmulator.firestore)
  }

  /**
   * Cleans up the test environment after each test.
   *
   * This method:
   * 1. Clears all users from the Auth emulator
   * 2. Clears all data from the Firestore emulator
   *
   * Logs are included for debugging purposes to track user cleanup.
   */
  @After
  open fun tearDown() = runTest (timeout = 120.seconds) {
    FirebaseEmulator.clearAuthEmulator()
    FirebaseEmulator.clearFirestoreEmulator()
  }

  /**
   * Sign in with the given fake JWT token.
   *
   * @param token The fake JWT token created with FakeJwtGenerator
   */
  protected suspend fun signInWithToken(token: String) {
    val credential = GoogleAuthProvider.getCredential(token, null)
    FirebaseEmulator.auth.signInWithCredential(credential).await()
  }
}
